version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: s1-ubuntu
    os_image: ""
blocks:
  - name: Docker build
    task:
      jobs:
        - name: Docker build
          commands:
            - checkout
            - cd 6-pipeline
            - echo $DOCKER_PASSWORD | docker login --username "$DOCKER_USERNAME" --password-stdin
            - 'docker pull $DOCKER_USERNAME/my-flask-app:latest || true'
            - 'docker build -t $DOCKER_USERNAME/my-flask-app:$SEMAPHORE_WORKFLOW_ID --cache-from $DOCKER_USERNAME/my-flask-app:latest .'
            - 'docker tag $DOCKER_USERNAME/my-flask-app:$SEMAPHORE_WORKFLOW_ID $DOCKER_USERNAME/my-flask-app:latest'
            - 'docker push $DOCKER_USERNAME/my-flask-app:$SEMAPHORE_WORKFLOW_ID'
            - 'docker push $DOCKER_USERNAME/my-flask-app:latest'
      secrets:
        - name: dockerhub
